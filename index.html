import React, { useState, useMemo, useRef, useEffect } from 'react';
import { ChevronLeft, ChevronRight, Calendar, ClipboardList, Instagram, CheckCircle2, Clock, Share2, Bell, X } from 'lucide-react';

// --- 외부 컴포넌트 분리 (한글 입력 버그 해결 및 가독성) ---

const HomeView = ({ setView, onShare }) => (
  <div className="animate-in fade-in duration-500">
    <nav className="fixed top-0 w-full max-w-[480px] z-50 bg-white/70 backdrop-blur-xl px-6 py-4 flex justify-between items-center border-b border-gray-50">
      <span className="text-xl font-black tracking-tighter uppercase italic text-lime-600 text-left">woolim pt</span>
      <div className="flex gap-2 text-right">
        <button 
          onClick={onShare}
          className="p-2 bg-gray-50 rounded-full text-gray-400 hover:text-lime-600 transition-colors"
        >
          <Share2 size={18}/>
        </button>
        <button className="p-2 bg-gray-50 rounded-full text-gray-400">
          <Bell size={18}/>
        </button>
      </div>
    </nav>

    <div className="relative w-full h-[480px]">
      <img src="https://images.unsplash.com/photo-1540497077202-7c8a3999166f?auto=format&fit=crop&q=80&w=800" 
           className="w-full h-full object-cover" style={{ maskImage: 'linear-gradient(to bottom, black 85%, transparent)' }} alt="Hero" />
      <div className="absolute bottom-16 left-0 w-full text-center px-6">
        <span className="bg-gray-900 text-white text-[10px] font-bold px-2 py-0.5 rounded-full mb-3 inline-block tracking-widest uppercase text-center">Premium PT Studio</span>
        <h1 className="text-4xl font-black tracking-tight leading-none mb-2 text-gray-900 uppercase italic text-center">woolim pt</h1>
        <p className="text-sm font-semibold text-gray-600 text-center">몸과 마음이 울리는 건강한 변화</p>
      </div>
    </div>

    <div className="px-5 pb-32 space-y-8">
      <div className="text-center space-y-3 pt-4">
        <h2 className="text-2xl font-black text-gray-900 leading-tight text-center text-left">전문 강사진의 <span className="text-lime-500">1:1 밀착 코칭</span></h2>
        <p className="text-sm text-gray-400 font-medium leading-relaxed text-center">광주 동구 운림동 유일의 프리미엄 PT샵<br/>체계적인 데이터 분석 개인별 맞춤 프로그램</p>
      </div>

      <div className="space-y-3">
        <div className="flex items-center gap-2 px-1">
          <Instagram size={18} className="text-pink-500" />
          <h3 className="text-sm font-bold text-gray-300 uppercase tracking-widest text-left">Woolim Lifestyle</h3>
        </div>
        <div className="w-full rounded-[32px] overflow-hidden shadow-2xl bg-black relative" style={{ paddingTop: '177.77%' }}>
          <iframe 
            className="absolute top-0 left-0 w-full h-full border-0" 
            src="https://www.instagram.com/reel/DRzFAbTD4KK/embed" 
            scrolling="no" 
            allowtransparency="true"
          ></iframe>
        </div>
      </div>

      <button 
        onClick={() => setView('survey')}
        className="w-full bg-white border-2 border-lime-100 rounded-[32px] p-6 shadow-sm hover:shadow-md transition-all flex items-center justify-between group"
      >
        <div className="flex items-center gap-4 text-left">
          <div className="w-12 h-12 rounded-2xl bg-lime-100 flex items-center justify-center text-lime-600"><ClipboardList size={24} /></div>
          <div>
            <h3 className="font-bold text-lg text-gray-900 text-left">무료 체형 상담 신청</h3>
            <p className="text-xs text-gray-400 mt-0.5 text-left text-left">인바디 측정 및 1:1 상담 예약</p>
          </div>
        </div>
        <ChevronRight className="text-gray-300 group-hover:translate-x-1 transition-transform" />
      </button>

      <FacilitySlider />

      <div className="py-4">
        <h3 className="text-lg font-black mb-4 px-1 italic uppercase text-gray-900 text-left text-left">Location</h3>
        <div className="bg-gray-50 rounded-[32px] overflow-hidden border border-gray-100 shadow-sm bg-white">
          <iframe className="w-full h-[240px]" 
                  src="https://maps.google.com/maps?q=광주광역시 동구 운림길 29-9&t=&z=17&ie=UTF8&iwloc=&output=embed"
                  loading="lazy"></iframe>
          <div className="p-6 flex items-center justify-between gap-4">
            <div className="flex-1 min-w-0 text-left">
              <p className="text-base font-bold text-gray-900 text-left">광주 동구 운림길 29-9 2층</p>
              <p className="text-[11px] text-gray-400 mt-1 font-medium text-left leading-tight text-left">운림동 무등파크맨션2차 정문 앞<br/>(구 집현전 독서실) 2층</p>
            </div>
            <button className="flex-shrink-0 bg-gray-900 text-white px-5 py-3 rounded-2xl text-xs font-bold shadow-lg shadow-gray-200">
              길찾기
            </button>
          </div>
        </div>
      </div>

      <div className="text-center py-10">
        <p className="text-[10px] font-black uppercase tracking-[6px] text-gray-300 text-center text-center text-center">Woolim PT Studio</p>
        <p className="text-[10px] mt-3 text-gray-300 text-center text-center text-center text-center">© 2024 WOOLIM PT. All rights reserved.</p>
      </div>
    </div>

    <div className="fixed bottom-6 left-1/2 -translate-x-1/2 w-full max-w-[440px] px-4 z-50">
      <button onClick={() => setView('survey')} className="w-full bg-lime-500 text-white py-5 text-center font-black text-lg rounded-3xl shadow-xl shadow-lime-500/30 uppercase italic">
        Start Consultation
      </button>
    </div>
  </div>
);

const SurveyView = ({ setView, bookingData, setBookingData, goalOptions, toggleGoal }) => (
  <div className="p-6 pt-24 animate-in slide-in-from-right duration-300 min-h-screen bg-white text-left">
    <button onClick={() => setView('home')} className="mb-8 flex items-center text-gray-400 font-bold hover:text-gray-600 transition-colors text-left"><ChevronLeft /> 뒤로가기</button>
    <div className="space-y-8 text-left">
      <div className="text-left">
        <h2 className="text-3xl font-black text-gray-900 mb-2 leading-tight text-left text-left">상담 전 <span className="text-lime-500">필수 정보</span>를<br/>입력해 주세요.</h2>
        <p className="text-sm text-gray-400 font-medium leading-relaxed text-left text-left">정확한 상담을 위해 필요한 항목입니다.</p>
      </div>

      <div className="space-y-6 text-left">
        <div className="space-y-2 text-left">
          <label className="text-xs font-bold text-gray-400 uppercase ml-1 tracking-widest text-left block">이름</label>
          <input 
            type="text" 
            placeholder="이름을 입력하세요" 
            value={bookingData.name}
            className="w-full p-5 rounded-[24px] bg-gray-50 border-2 border-transparent focus:border-lime-500 focus:bg-white transition-all outline-none font-bold text-gray-900 text-left"
            onChange={(e) => setBookingData(prev => ({ ...prev, name: e.target.value }))}
          />
        </div>
        <div className="space-y-2 text-left">
          <label className="text-xs font-bold text-gray-400 uppercase ml-1 tracking-widest text-left block">연락처</label>
          <input 
            type="tel" 
            placeholder="010-0000-0000" 
            value={bookingData.phone}
            className="w-full p-5 rounded-[24px] bg-gray-50 border-2 border-transparent focus:border-lime-500 focus:bg-white transition-all outline-none font-bold text-gray-900 text-left"
            onChange={(e) => setBookingData(prev => ({ ...prev, phone: e.target.value }))}
          />
        </div>
        <div className="space-y-3 text-left">
          <label className="text-xs font-bold text-gray-400 uppercase ml-1 tracking-widest text-left block">상담 목적 (중복 선택 가능)</label>
          <div className="grid grid-cols-2 gap-2 text-center">
            {goalOptions.map(goal => (
              <button 
                key={goal}
                onClick={() => toggleGoal(goal)}
                className={`p-4 rounded-[20px] text-sm font-bold transition-all border-2 text-center ${bookingData.goal.includes(goal) ? 'bg-lime-500 text-white border-lime-500 shadow-lg shadow-lime-500/20' : 'bg-gray-50 text-gray-400 border-transparent hover:border-gray-200'}`}
              >
                {goal}
              </button>
            ))}
          </div>
        </div>
      </div>

      <button 
        disabled={!bookingData.name || !bookingData.phone || bookingData.goal.length === 0}
        onClick={() => setView('instructors')} 
        className="w-full bg-gray-900 text-white py-5 rounded-[24px] font-black text-lg disabled:opacity-10 mt-6 shadow-xl active:scale-[0.98] transition-transform text-center"
      >
        다음 단계로
      </button>
    </div>
  </div>
);

const InstructorView = ({ setView, instructors, bookingData, setBookingData }) => (
  <div className="p-6 pt-24 animate-in slide-in-from-right duration-300 min-h-screen bg-white text-left">
    <button onClick={() => setView('survey')} className="mb-8 flex items-center text-gray-400 font-bold text-left"><ChevronLeft /> 뒤로가기</button>
    <div className="space-y-6 text-left text-left">
      <div className="text-left">
        <h2 className="text-3xl font-black text-gray-900 mb-2 leading-tight text-left text-left text-left text-left">함께 하실 <span className="text-lime-500">강사님</span>을<br/>선택해 주세요.</h2>
        <p className="text-sm text-gray-400 font-medium leading-relaxed text-left text-left text-left text-left">전담 코칭을 통해 확실한 변화를 만들어 드립니다.</p>
      </div>

      <div className="space-y-3 pb-8 text-left">
        {instructors.map(ins => (
          <button 
            key={ins.id}
            onClick={() => {
              setBookingData(prev => ({...prev, instructor: ins}));
              setView('booking');
            }}
            className={`w-full flex items-center gap-4 p-4 rounded-[28px] border-2 transition-all ${bookingData.instructor?.id === ins.id ? 'border-lime-500 bg-lime-50' : 'border-gray-50 bg-white hover:border-gray-200'}`}
          >
            <img src={ins.img} className="w-16 h-16 rounded-[20px] object-cover shadow-sm" alt={ins.name} />
            <div className="text-left">
              <p className="font-bold text-gray-900 text-lg text-left text-left">{ins.name}</p>
              <p className="text-xs text-gray-400 font-medium leading-tight text-left text-left text-left text-left">{ins.role}</p>
            </div>
            <ChevronRight className="ml-auto text-gray-200 text-right" />
          </button>
        ))}
      </div>
    </div>
  </div>
);

const BookingView = ({ setView, bookingData, setBookingData, timeSlots, days }) => (
  <div className="p-6 pt-24 animate-in slide-in-from-right duration-300 min-h-screen bg-white text-left">
    <button onClick={() => setView('instructors')} className="mb-8 flex items-center text-gray-400 font-bold text-left text-left"><ChevronLeft /> 뒤로가기</button>
    <div className="space-y-6 text-left text-left text-left">
      <div className="flex items-center justify-between text-left text-left text-left text-left">
        <div className="text-left">
          <h2 className="text-2xl font-black text-gray-900 mb-1 leading-tight text-left text-left text-left text-left">상담 날짜와 <span className="text-lime-500">시간</span></h2>
          <p className="text-xs text-gray-400 font-medium text-left text-left text-left text-left">{bookingData.instructor?.name} 강사님 상담 예약</p>
        </div>
        <div className="w-14 h-14 rounded-full overflow-hidden border-2 border-lime-400 shadow-md text-right">
          <img src={bookingData.instructor?.img} className="w-full h-full object-cover" alt="selected" />
        </div>
      </div>

      <div className="bg-gray-50 rounded-[32px] p-6 border border-gray-100 shadow-sm">
        <div className="flex justify-between items-center mb-6 px-1 text-center">
           <span className="font-black text-gray-900 text-lg tracking-tighter text-left">2026. 01</span>
           <div className="flex gap-2 text-center text-center">
              <button className="p-1.5 bg-white rounded-xl shadow-sm text-gray-300"><ChevronLeft size={18} /></button>
              <button className="p-1.5 bg-white rounded-xl shadow-sm"><ChevronRight size={18} /></button>
           </div>
        </div>
        <div className="grid grid-cols-7 gap-y-4 text-center">
          {['일','월','화','수','목','금','토'].map(d => <span key={d} className="text-[10px] font-bold text-gray-300 uppercase text-center text-center">{d}</span>)}
          {days.map(d => (
            <button 
              key={d} 
              onClick={() => setBookingData(prev => ({...prev, date: d}))}
              className={`text-sm font-bold w-10 h-10 mx-auto rounded-full flex items-center justify-center transition-all text-center ${bookingData.date === d ? 'bg-lime-500 text-white shadow-lg shadow-lime-500/30 scale-110' : 'text-gray-900 hover:bg-white'}`}
            >
              {d}
            </button>
          ))}
        </div>
      </div>

      {bookingData.date && (
        <div className="space-y-4 animate-in fade-in slide-in-from-bottom duration-500 pt-2 text-left text-left">
          <h3 className="text-xs font-black text-gray-300 uppercase tracking-widest flex items-center gap-2 px-1 text-left text-left text-left"><Clock size={14}/> Available Slots</h3>
          <div className="grid grid-cols-4 gap-2 text-center">
            {timeSlots.map(slot => (
              <button 
                key={slot.time}
                disabled={!slot.available}
                onClick={() => setBookingData(prev => ({...prev, time: slot.time}))}
                className={`py-3.5 rounded-[16px] text-xs font-black transition-all text-center text-center ${!slot.available ? 'bg-gray-100 text-gray-200' : (bookingData.time === slot.time ? 'bg-gray-900 text-white shadow-xl' : 'bg-white border border-gray-100 text-gray-900 hover:border-gray-300')}`}
              >
                {slot.time}
              </button>
            ))}
          </div>
        </div>
      )}

      <button 
        disabled={!bookingData.date || !bookingData.time}
        onClick={() => setView('complete')}
        className="w-full bg-lime-500 text-white py-5 rounded-[24px] font-black text-lg disabled:opacity-10 mt-6 shadow-xl shadow-lime-500/20 active:scale-[0.98] transition-all text-center"
      >
        예약 완료
      </button>
    </div>
  </div>
);

const CompleteView = ({ setView, bookingData, setBookingData }) => (
  <div className="flex flex-col items-center justify-center min-h-screen p-8 text-center animate-in zoom-in-95 duration-500 bg-white">
    <div className="w-24 h-24 bg-lime-100 text-lime-600 rounded-[32px] flex items-center justify-center mb-8 shadow-lg shadow-lime-100">
      <CheckCircle2 size={48} />
    </div>
    <h2 className="text-3xl font-black text-gray-900 mb-4 tracking-tight leading-tight text-center text-center">상담 예약이<br/>확정되었습니다!</h2>
    <div className="space-y-1 text-gray-400 font-medium mb-12 text-center text-center text-center">
      <p className="text-center text-center"><span className="text-gray-900 font-bold">{bookingData.name}</span>님, 곧 강사님이 연락드릴게요.</p>
      <p className="text-center text-center text-sm font-medium text-center">기다려 주셔서 감사합니다.</p>
    </div>

    <div className="w-full bg-gray-50 rounded-[32px] p-8 text-left space-y-5 mb-12 border border-gray-100 text-left text-left text-left">
      <div className="flex justify-between items-start text-left text-left text-left">
        <span className="text-xs font-bold text-gray-300 uppercase tracking-widest text-left text-left">일시</span>
        <span className="text-sm font-bold text-gray-900 text-right text-right">1월 {bookingData.date}일 {bookingData.time}</span>
      </div>
      <div className="flex justify-between items-start text-left text-left text-left">
        <span className="text-xs font-bold text-gray-300 uppercase tracking-widest text-left text-left text-left">강사</span>
        <span className="text-sm font-bold text-lime-600 text-right text-right">{bookingData.instructor?.name}</span>
      </div>
      <div className="flex justify-between items-start text-left text-left text-left">
        <span className="text-xs font-bold text-gray-300 uppercase tracking-widest text-left text-left text-left">목적</span>
        <span className="text-sm font-bold text-gray-900 text-right flex-1 ml-4 leading-tight text-right text-right">{bookingData.goal.join(', ')}</span>
      </div>
    </div>

    <button onClick={() => {
      setBookingData({name:'', phone:'', goal:[], instructor:null, date:null, time:null});
      setView('home');
    }} className="w-full py-5 bg-gray-900 text-white rounded-[24px] font-black shadow-2xl active:scale-[0.98] transition-transform text-center text-center">
      메인으로 이동
    </button>
  </div>
);

const FacilitySlider = () => {
  const scrollRef = useRef(null);
  const [isDown, setIsDown] = useState(false);
  const [startX, setStartX] = useState(0);
  const [scrollLeft, setScrollLeft] = useState(0);

  const handleMouseDown = (e) => {
    setIsDown(true);
    setStartX(e.pageX - scrollRef.current.offsetLeft);
    setScrollLeft(scrollRef.current.scrollLeft);
  };

  const handleMouseMove = (e) => {
    if (!isDown) return;
    e.preventDefault();
    const x = e.pageX - scrollRef.current.offsetLeft;
    const walk = (x - startX) * 2;
    scrollRef.current.scrollLeft = scrollLeft - walk;
  };

  return (
    <div className="py-6">
      <div className="flex justify-between items-end mb-4 px-1 text-left">
        <h3 className="text-lg font-black italic uppercase text-gray-900 text-left text-left text-left">Gym Facilities</h3>
        <span className="text-[10px] font-bold text-gray-300 uppercase tracking-widest text-right">Drag to view</span>
      </div>
      <div 
        ref={scrollRef}
        onMouseDown={handleMouseDown}
        onMouseLeave={() => setIsDown(false)}
        onMouseUp={() => setIsDown(false)}
        onMouseMove={handleMouseMove}
        className="flex overflow-x-auto gap-4 pb-4 cursor-grab active:cursor-grabbing no-scrollbar"
        style={{ scrollSnapType: 'x mandatory', scrollbarWidth: 'none' }}
      >
        {[
          { title: 'Personal Training Zone', desc: '1:1 수업 전용 독립 공간', img: 'https://images.unsplash.com/photo-1534438327276-14e5300c3a48?auto=format&fit=crop&q=80&w=600' },
          { title: 'Premium Equipment', desc: '최고급 외산 머신 웨이트 존', img: 'https://images.unsplash.com/photo-1593079831268-3381b0db4a77?auto=format&fit=crop&q=80&w=600' },
          { title: 'Private Shower Room', desc: '개인별 프라이빗 샤워실', img: 'https://images.unsplash.com/photo-1571902943202-507ec2618e8f?auto=format&fit=crop&q=80&w=600' }
        ].map((item, idx) => (
          <div key={idx} className="min-w-[280px] scroll-snap-align-center bg-gray-50 rounded-3xl overflow-hidden border border-gray-100">
            <img src={item.img} className="w-full h-44 object-cover" alt={item.title} />
            <div className="p-4 bg-white text-left text-left">
              <p className="text-sm font-bold text-gray-900 text-left text-left text-left">{item.title}</p>
              <p className="text-[11px] text-gray-400 mt-1 font-medium text-left text-left text-left">{item.desc}</p>
            </div>
          </div>
        ))}
      </div>
    </div>
  );
};

// --- 메인 App 컴포넌트 ---

export default function App() {
  const [view, setView] = useState('home');
  const [toast, setToast] = useState({ show: false, message: '' });
  const [bookingData, setBookingData] = useState({
    name: '',
    phone: '',
    goal: [],
    instructor: null,
    date: null,
    time: null
  });

  const goalOptions = [
    '다이어트', '체력 증진', '근력 향상', '체형 교정', 
    '바디프로필', '재활 운동', '산전/산후 관리', '웨딩 케어'
  ];

  const instructors = [
    { id: 1, name: 'Jay (제이)', role: '재활 및 체형교정 전문', img: 'https://images.unsplash.com/photo-1567013127542-490d757e51fc?auto=format&fit=crop&q=80&w=200' },
    { id: 2, name: 'Mina (미나)', role: '바디프로필 및 다이어트', img: 'https://images.unsplash.com/photo-1548690312-e3b507d8df11?auto=format&fit=crop&q=80&w=200' },
    { id: 3, name: 'Ken (켄)', role: '고강도 근력 및 벌크업', img: 'https://images.unsplash.com/photo-1507398941214-57f516d901ca?auto=format&fit=crop&q=80&w=200' },
    { id: 4, name: 'Sarah (사라)', role: '여성 맞춤형 라인 코칭', img: 'https://images.unsplash.com/photo-1594381898411-846e7d193883?auto=format&fit=crop&q=80&w=200' },
    { id: 5, name: 'Rio (리오)', role: '기초 체력 및 유연성 관리', img: 'https://images.unsplash.com/photo-1571019613454-1cb2f99b2d8b?auto=format&fit=crop&q=80&w=200' },
  ];

  const timeSlots = [
    { time: '10:00', available: true },
    { time: '11:00', available: false },
    { time: '13:00', available: true },
    { time: '14:00', available: true },
    { time: '15:00', available: false },
    { time: '16:00', available: true },
    { time: '17:00', available: true },
    { time: '18:00', available: false },
    { time: '19:00', available: true },
    { time: '20:00', available: true },
  ];

  const days = useMemo(() => Array.from({ length: 31 }, (_, i) => i + 1), []);

  const toggleGoal = (goal) => {
    setBookingData(prev => {
      const isSelected = prev.goal.includes(goal);
      if (isSelected) {
        return { ...prev, goal: prev.goal.filter(g => g !== goal) };
      } else {
        return { ...prev, goal: [...prev.goal, goal] };
      }
    });
  };

  const showToastMessage = (msg) => {
    setToast({ show: true, message: msg });
    setTimeout(() => setToast({ show: false, message: '' }), 2500);
  };

  const handleShare = () => {
    const url = window.location.href;
    
    // Web Share API 시도
    if (navigator.share) {
      navigator.share({
        title: 'WOOLIM PT',
        text: 'WOOLIM PT 프리미엄 퍼스널 트레이닝 센터',
        url: url
      }).catch(() => {
        copyToClipboard(url);
      });
    } else {
      copyToClipboard(url);
    }
  };

  const copyToClipboard = (text) => {
    const textarea = document.createElement('textarea');
    textarea.value = text;
    textarea.style.position = 'fixed';
    textarea.style.left = '-9999px';
    textarea.style.top = '0';
    document.body.appendChild(textarea);
    textarea.focus();
    textarea.select();
    
    try {
      document.execCommand('copy');
      showToastMessage('페이지 주소가 클립보드에 복사되었습니다.');
    } catch (err) {
      showToastMessage('주소 복사에 실패했습니다.');
    }
    document.body.removeChild(textarea);
  };

  return (
    <div className="flex justify-center bg-gray-100 min-h-screen font-sans">
      <div className="bg-white shadow-2xl overflow-x-hidden relative w-full max-w-[480px]">
        {view === 'home' && <HomeView setView={setView} onShare={handleShare} />}
        {view === 'survey' && (
          <SurveyView 
            setView={setView} 
            bookingData={bookingData} 
            setBookingData={setBookingData} 
            goalOptions={goalOptions} 
            toggleGoal={toggleGoal} 
          />
        )}
        {view === 'instructors' && (
          <InstructorView 
            setView={setView} 
            instructors={instructors} 
            bookingData={bookingData} 
            setBookingData={setBookingData} 
          />
        )}
        {view === 'booking' && (
          <BookingView 
            setView={setView} 
            bookingData={bookingData} 
            setBookingData={setBookingData} 
            timeSlots={timeSlots} 
            days={days} 
          />
        )}
        {view === 'complete' && (
          <CompleteView 
            setView={setView} 
            bookingData={bookingData} 
            setBookingData={setBookingData} 
          />
        )}

        {/* Toast 알림 메시지 */}
        {toast.show && (
          <div className="fixed bottom-32 left-1/2 -translate-x-1/2 z-[100] animate-in slide-in-from-bottom-4 duration-300">
            <div className="bg-gray-900/90 backdrop-blur text-white px-6 py-3 rounded-full text-xs font-bold shadow-2xl flex items-center gap-2 whitespace-nowrap">
              <CheckCircle2 size={14} className="text-lime-400" />
              {toast.message}
            </div>
          </div>
        )}
      </div>
    </div>
  );
}
